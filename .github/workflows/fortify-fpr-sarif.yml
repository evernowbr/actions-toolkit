name: Fortify FPR → SARIF Converter (Linux)

on:
  workflow_call:
    inputs:
      enable_sarif_multitool:
        description: 'Habilita conversão FPR→SARIF usando SARIF MultiTool'
        required: false
        default: 'true'
        type: string
      dotnet_version:
        description: 'Versão do .NET SDK para instalar'
        required: false
        default: '8.0.x'
        type: string
      sarif_multitool_version:
        description: 'Versão do SARIF MultiTool'
        required: false
        default: '4.5.4'
        type: string
      fpr_artifact_name:
        description: 'Nome do artefato contendo arquivos .fpr'
        required: false
        default: 'fortify-results'
        type: string
      validate_sarif:
        description: 'Validar arquivos SARIF gerados'
        required: false
        default: 'true'
        type: string
      fortify_project_name:
        description: 'Nome do projeto Fortify'
        required: false
        default: 'Unknown'
        type: string
      fortify_version_name:
        description: 'Versão do projeto Fortify'
        required: false
        default: 'Unknown'
        type: string
    secrets:
      FORTIFY_SSC_API_URL:
        required: false
      FORTIFY_UNIFIED_LOGIN_TOKEN:
        required: false

jobs:
  convert-fpr-linux:
    name: Convert FPR to SARIF (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: ${{ fromJSON(inputs.enable_sarif_multitool) }}
    permissions:
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744

      - name: Download FPR artifacts
        uses: actions/download-artifact@65a9edc5881444af0b9093a5e628f2fe47ea3b2e
        with:
          name: ${{ inputs.fpr_artifact_name }}
          path: ./fpr-files

      - name: Validate prerequisites
        run: |
          set -euo pipefail
          
          if [[ ! "${{ inputs.fortify_project_name }}" =~ ^[a-zA-Z0-9_.-]{1,50}$ ]]; then
            echo "❌ Nome do projeto inválido"
            exit 1
          fi
          
          if [[ ! "${{ inputs.fortify_version_name }}" =~ ^[a-zA-Z0-9_.-]{1,30}$ ]]; then
            echo "❌ Nome da versão inválido"
            exit 1
          fi
          
          if [[ ! "${{ inputs.sarif_multitool_version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Versão SARIF MultiTool inválida"
            exit 1
          fi
          
          if [ ! -d "./fpr-files" ]; then
            echo "❌ Diretório fpr-files não encontrado"
            exit 1
          fi
          
          fpr_files=$(find ./fpr-files -name "*.fpr" 2>/dev/null | wc -l)
          if [ "$fpr_files" -eq 0 ]; then
            echo "❌ Nenhum arquivo .fpr encontrado"
            exit 1
          fi
          
          echo "✅ Encontrados $fpr_files arquivos FPR"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@6bd8b7f7774af54e05809fcc5431931b3eb1ddee
        with:
          dotnet-version: ${{ inputs.dotnet_version }}

      - name: Cache .NET tools
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9
        with:
          path: ~/.dotnet/tools
          key: dotnet-tools-${{ inputs.sarif_multitool_version }}-${{ github.repository }}-${{ hashFiles('**/*.yml', '**/*.yaml') }}
          restore-keys: |
            dotnet-tools-${{ inputs.sarif_multitool_version }}-${{ github.repository }}-
            dotnet-tools-${{ inputs.sarif_multitool_version }}-

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Install SARIF MultiTool
        run: |
          for attempt in {1..3}; do
            if dotnet tool install --global Sarif.Multitool --version ${{ inputs.sarif_multitool_version }}; then
              break
            else
              echo "⚠️ Tentativa $attempt falhou, tentando novamente em 5s..."
              sleep 5
            fi
          done
          
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
          
          timeout 30s sarif --version || {
            echo "❌ Falha na verificação do SARIF MultiTool"
            exit 1
          }

      - name: Convert FPR files to SARIF
        shell: bash
        env:
          FORTIFY_SSC_API_URL: ${{ secrets.FORTIFY_SSC_API_URL }}
          FORTIFY_UNIFIED_LOGIN_TOKEN: ${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}
          FORTIFY_PROJECT_NAME: ${{ inputs.fortify_project_name }}
          FORTIFY_VERSION_NAME: ${{ inputs.fortify_version_name }}
        run: |
          set -euo pipefail
          IFS=$'\n\t'
          trap 'echo "❌ Script falhou na linha $LINENO"' ERR
          
          mkdir -p ./sarif-output
          
          fpr_count=0
          converted_count=0
          failed_count=0
          
          shopt -s globstar
          for fpr_file in ./fpr-files/**/*.fpr; do
            if [ -f "$fpr_file" ]; then
              fpr_count=$((fpr_count + 1))
              echo "📁 Processando: $fpr_file"
              
              sarif_file="./sarif-output/$(basename "$fpr_file" .fpr).sarif"
              
              if sarif convert "$fpr_file" --tool FortifyFpr --output "$sarif_file" --pretty-print --force; then
                converted_count=$((converted_count + 1))
                echo "✅ Convertido: $sarif_file"
                
                if [ -f "$sarif_file" ]; then
                  apply_fortify_metadata() {
                      local sarif_file="$1"
                      local temp_file="${sarif_file}.tmp"
                      
                      if [[ ! -f "$sarif_file" ]] || [[ ! -s "$sarif_file" ]]; then
                          return 1
                      fi
                      
                      if ! jq empty "$sarif_file" 2>/dev/null; then
                          return 1
                      fi
                      
                      local schema_version=$(jq -r '."$schema" // empty' "$sarif_file" 2>/dev/null)
                      local sarif_version=$(jq -r '.version // empty' "$sarif_file" 2>/dev/null)
                      
                      if [[ -z "$schema_version" || -z "$sarif_version" ]]; then
                          return 1
                      fi
                      
                      local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                      local fortify_version="25.2.0"
                      
                      if jq --arg timestamp "$timestamp" \
                            --arg project_name "$FORTIFY_PROJECT_NAME" \
                            --arg version_name "$FORTIFY_VERSION_NAME" \
                            --arg fortify_version "$fortify_version" \
                            --arg version_id "0" '
                         if (.runs | type) != "array" or (.runs | length) == 0 then 
                             .runs = [{"tool": {"driver": {}}, "invocations": [{}], "results": []}] 
                         else . end |
                         
                         (.runs[0].tool.driver.name = "Fortify Static Code Analyzer") |
                         (.runs[0].tool.driver.version = $fortify_version) |
                         (.runs[0].tool.driver.informationUri = "https://www.microfocus.com/en-us/cyberres/application-security/static-code-analyzer") |
                         
                         if (.runs[0].invocations | type) != "array" or (.runs[0].invocations | length) == 0 then
                             .runs[0].invocations = [{}]
                         else . end |
                         
                         (.runs[0].invocations[0].startTimeUtc = $timestamp) |
                         (.runs[0].invocations[0].endTimeUtc = $timestamp) |
                         (.runs[0].invocations[0].executionSuccessful = true) |
                         (.runs[0].invocations[0].commandLine = "scancentral") |
                         (.runs[0].invocations[0].workingDirectory = {"uri": "file:///github/workspace/"}) |
                         
                         if (.runs[0].results | type) == "array" then
                             .runs[0].results |= map(
                                 if (.locations | type) == "array" and (.locations | length) > 0 and
                                    .locations[0].physicalLocation.artifactLocation.uri and
                                    .locations[0].physicalLocation.region.startLine and
                                    .ruleId then
                                     . + {
                                         "partialFingerprints": {
                                             "primaryLocationLineHash": (.locations[0].physicalLocation.artifactLocation.uri + ":" + (.locations[0].physicalLocation.region.startLine | tostring) + ":" + .ruleId)
                                         },
                                         "properties": {
                                             "fortify_project": $project_name,
                                             "fortify_version": $version_name,
                                             "fortify_version_id": $version_id,
                                             "fortify_scan_time": $timestamp,
                                             "fortify_engine_version": $fortify_version
                                         }
                                     }
                                 else
                                     .
                                 end
                             )
                         else . end' "$sarif_file" > "$temp_file"; then
                          
                          if jq empty "$temp_file" 2>/dev/null && [[ -s "$temp_file" ]]; then
                              mv "$temp_file" "$sarif_file"
                              return 0
                          else
                              rm -f "$temp_file"
                              return 1
                          fi
                      else
                          rm -f "$temp_file"
                          return 1
                      fi
                  }
                  
                  apply_fortify_metadata "$sarif_file" && echo "✅ Metadados Fortify adicionados"
                fi
                
                if [ -f "$sarif_file" ]; then
                  file_size=$(wc -c < "$sarif_file")
                  echo "📊 Tamanho: $((file_size/1024))KB"
                fi
              else
                failed_count=$((failed_count + 1))
                echo "❌ Falha na conversão: $fpr_file"
              fi
            fi
          done
          
          if [ "$fpr_count" -eq 0 ]; then
            echo "❌ Nenhum arquivo FPR encontrado"
            exit 1
          fi
          
          echo "📈 Resumo da conversão:"
          echo "   • Arquivos FPR encontrados: $fpr_count"
          echo "   • Arquivos convertidos: $converted_count"
          echo "   • Falhas na conversão: $failed_count"
          
          if [ "$fpr_count" -gt 0 ]; then
            success_rate=$((converted_count * 100 / fpr_count))
            echo "   • Taxa de sucesso: ${success_rate}%"
          fi
          
          if [ "$converted_count" -eq 0 ] && [ "$fpr_count" -gt 0 ]; then
            echo "❌ Nenhum arquivo foi convertido com sucesso"
            exit 1
          fi
          
          echo "### 📊 Conversão FPR → SARIF (Linux)" >> $GITHUB_STEP_SUMMARY
          echo "| Métrica | Valor | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| FPR Processados | $fpr_count | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| SARIF Gerados | $converted_count | $([ $converted_count -gt 0 ] && echo "✅" || echo "❌") |" >> $GITHUB_STEP_SUMMARY
          echo "| Taxa Sucesso | ${success_rate}% | $([ $success_rate -gt 90 ] && echo "✅" || echo "⚠️") |" >> $GITHUB_STEP_SUMMARY

      - name: Validate SARIF files
        if: ${{ fromJSON(inputs.validate_sarif) }}
        shell: bash
        run: |
          validation_errors=0
          valid_files=0
          total_files=0
          
          for sarif_file in ./sarif-output/*.sarif; do
            if [ -f "$sarif_file" ]; then
              total_files=$((total_files + 1))
              echo "🔍 Validando: $(basename "$sarif_file")"
              
              if sarif validate "$sarif_file"; then
                valid_files=$((valid_files + 1))
                echo "✅ Válido: $(basename "$sarif_file")"
              else
                validation_errors=$((validation_errors + 1))
                echo "❌ Inválido: $(basename "$sarif_file")"
              fi
            fi
          done
          
          echo "📊 Resultado da validação:"
          echo "   • Total de arquivos: $total_files"
          echo "   • Arquivos válidos: $valid_files"
          echo "   • Erros de validação: $validation_errors"
          
          if [ "$valid_files" -eq 0 ] && [ "$total_files" -gt 0 ]; then
            echo "❌ Todos os arquivos SARIF são inválidos"
            exit 1
          fi

      - name: Analyze SARIF content
        shell: bash
        run: |
          for sarif_file in ./sarif-output/*.sarif; do
            if [ -f "$sarif_file" ]; then
              echo ""
              echo "📋 $(basename "$sarif_file"):"
              
              critical_high=$(jq '.runs[0].results[] | select(.level == "error") | .ruleId' "$sarif_file" 2>/dev/null | wc -l)
              medium=$(jq '.runs[0].results[] | select(.level == "warning") | .ruleId' "$sarif_file" 2>/dev/null | wc -l)
              low=$(jq '.runs[0].results[] | select(.level == "note") | .ruleId' "$sarif_file" 2>/dev/null | wc -l)
              total=$(jq '.runs[0].results | length' "$sarif_file" 2>/dev/null || echo "0")
              
              echo "   • Total de findings: $total"
              echo "   • Critical/High: $critical_high"
              echo "   • Medium: $medium"
              echo "   • Low: $low"
              
              unique_rules=$(jq '.runs[0].results[].ruleId' "$sarif_file" 2>/dev/null | sort | uniq | wc -l)
              echo "   • Regras únicas: $unique_rules"
            fi
          done

      - name: Upload SARIF artifacts
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874
        with:
          name: fortify-sarif-linux
          path: './sarif-output/*.sarif'
          if-no-files-found: error 
