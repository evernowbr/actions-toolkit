name: Fortify FPR to SARIF Converter

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
        description: 'Nome do projeto Fortify'
      version:
        required: true
        type: string
        description: 'Vers√£o do projeto Fortify'
      dotnet_version:
        description: 'Vers√£o do .NET SDK'
        required: false
        default: '8.0.x'
        type: string
      validate_sarif:
        description: 'Validar SARIF gerado'
        required: false
        default: 'true'
        type: string
      timeout_minutes:
        description: 'Timeout em minutos'
        required: false
        default: 45
        type: number
    secrets:
      FORTIFY_SSC_API_URL:
        required: true
        description: 'URL da API do Fortify SSC'
      FORTIFY_UNIFIED_LOGIN_TOKEN:
        required: true
        description: 'Token de autentica√ß√£o Fortify'

jobs:
  convert:
    name: Fortify FPR to SARIF Conversion
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout_minutes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744

      - name: Install dependencies
        run: |
          echo "üì¶ Instalando depend√™ncias..."
          sudo apt-get update -qq
          sudo apt-get install -y jq curl
          echo "‚úÖ Depend√™ncias instaladas"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet_version }}

      - name: Install SARIF MultiTool
        run: |
          echo "üîß Instalando SARIF MultiTool..."
          
          if ! dotnet tool install --global Sarif.Multitool; then
            echo "‚ùå Falha na instala√ß√£o do SARIF MultiTool"
            exit 1
          fi
          
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
          echo "‚úÖ SARIF MultiTool instalado"

      - name: Validate and Setup
        env:
          fortify_ssc_api_url: ${{ secrets.FORTIFY_SSC_API_URL }}
          fortify_unified_login_token: ${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}
        run: |
          echo "üîç Validando configura√ß√£o..."
          
          # ========== FUN√á√ïES UTILIT√ÅRIAS ==========
          
          # Fun√ß√£o de valida√ß√£o JSON robusta
          validate_json_response() {
              local response="$1"
              local context="$2"
              
              if [ -z "$response" ]; then
                  echo "‚ùå Resposta vazia da API ($context)"
                  return 1
              fi
              
              if ! echo "$response" | jq -e . >/dev/null 2>&1; then
                  echo "‚ùå JSON inv√°lido ($context):"
                  echo "$response" | head -10
                  return 1
              fi
              
              local error_msg=$(echo "$response" | jq -r '.message // empty')
              if [ -n "$error_msg" ]; then
                  echo "‚ùå Erro da API ($context): $error_msg"
                  return 1
              fi
              
              return 0
          }
          
          # Fun√ß√£o segura para chamadas API
          api_call() {
              local method="${1:-GET}"
              local url="$2"
              local data="${3:-}"
              local context="$4"
              
              local curl_opts=(-sS -k -L --fail)
              curl_opts+=(-H "Content-Type: application/json")
              curl_opts+=(-H "Accept: application/json")
              curl_opts+=(-H "Authorization: FortifyToken $fortify_unified_login_token")
              
              if [ "$method" = "POST" ] || [ "$method" = "PUT" ]; then
                  curl_opts+=(-X "$method")
                  if [ -n "$data" ]; then
                      curl_opts+=(-d "$data")
                  fi
              fi
              
              curl_opts+=("$url")
              
              local response
              local exit_code
              
              response=$(curl "${curl_opts[@]}" 2>/dev/null) || exit_code=$?
              
              if [ "${exit_code:-0}" -ne 0 ]; then
                  echo "‚ùå Falha na chamada API ($context): $exit_code"
                  return 1
              fi
              
              if ! validate_json_response "$response" "$context"; then
                  return 1
              fi
              
              echo "$response"
              return 0
          }
          
          # Fun√ß√£o para sanitizar inputs
          sanitize_input() {
              local input="$1"
              local max_length="${2:-100}"
              
              local sanitized=$(echo "$input" | tr -d '\n\r\t' | sed 's/[^a-zA-Z0-9._-]//g' | head -c "$max_length")
              
              if [[ -z "$sanitized" ]]; then
                  sanitized=$(echo "$input" | tr -d '\n\r\t' | head -c "$max_length")
                  if [[ -z "$sanitized" ]]; then
                      return 1
                  fi
              fi
              
              echo "$sanitized"
          }
          
          # ========== VALIDA√á√ÉO DE INPUTS ==========
          
          if [[ -z "${{ inputs.name }}" ]]; then
            echo "‚ùå Nome do projeto √© obrigat√≥rio"
            exit 1
          fi
          
          if [[ -z "${{ inputs.version }}" ]]; then
            echo "‚ùå Vers√£o do projeto √© obrigat√≥ria"
            exit 1
          fi
          
          PROJECT_NAME=$(sanitize_input "${{ inputs.name }}" 100)
          PROJECT_VERSION=$(sanitize_input "${{ inputs.version }}" 50)
          
          if [[ $? -ne 0 ]]; then
            echo "‚ùå Falha na sanitiza√ß√£o dos inputs"
            exit 1
          fi
          
          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
          echo "PROJECT_VERSION=$PROJECT_VERSION" >> $GITHUB_ENV
          
          # ========== VALIDA√á√ÉO DE SECRETS ==========
          
          if [[ -z "${{ secrets.FORTIFY_SSC_API_URL }}" ]]; then
            echo "‚ùå FORTIFY_SSC_API_URL n√£o configurado"
            exit 1
          fi
          
          if ! echo "${{ secrets.FORTIFY_SSC_API_URL }}" | grep -qE '^https?://'; then
            echo "‚ùå FORTIFY_SSC_API_URL formato inv√°lido"
            exit 1
          fi
          
          if [[ -z "${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}" ]]; then
            echo "‚ùå FORTIFY_UNIFIED_LOGIN_TOKEN n√£o configurado"
            exit 1
          fi
          
          # ========== TESTE DE CONECTIVIDADE ==========
          
          echo "üåê Testando conectividade..."
          if ! curl -k -sSL --connect-timeout 10 --max-time 30 "$fortify_ssc_api_url" >/dev/null 2>&1; then
            echo "‚ùå Servidor n√£o acess√≠vel"
            exit 1
          fi
          
          echo "üîê Testando autentica√ß√£o..."
          response=$(api_call "GET" "$fortify_ssc_api_url/projectVersions" "" "teste de autentica√ß√£o")
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Configura√ß√£o validada"
          else
            echo "‚ùå Falha na autentica√ß√£o"
            exit 1
          fi

      - name: Download FPR
        env:
          fortify_project_name: ${{ env.PROJECT_NAME }}
          fortify_version_name: ${{ env.PROJECT_VERSION }}
          fortify_ssc_api_url: ${{ secrets.FORTIFY_SSC_API_URL }}
          fortify_unified_login_token: ${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}
        run: |
          echo "üì• Baixando FPR..."
          
          # Fun√ß√£o de valida√ß√£o JSON robusta
          validate_json_response() {
              local response="$1"
              local context="$2"
              
              if [ -z "$response" ]; then
                  echo "‚ùå Resposta vazia da API ($context)"
                  return 1
              fi
              
              if ! echo "$response" | jq -e . >/dev/null 2>&1; then
                  echo "‚ùå JSON inv√°lido ($context):"
                  echo "$response" | head -10
                  return 1
              fi
              
              local error_msg=$(echo "$response" | jq -r '.message // empty')
              if [ -n "$error_msg" ]; then
                  echo "‚ùå Erro da API ($context): $error_msg"
                  return 1
              fi
              
              return 0
          }
          
          # Fun√ß√£o segura para chamadas API
          api_call() {
              local method="${1:-GET}"
              local url="$2"
              local data="${3:-}"
              local context="$4"
              
              local curl_opts=(-sS -k -L --fail)
              curl_opts+=(-H "Content-Type: application/json")
              curl_opts+=(-H "Accept: application/json")
              curl_opts+=(-H "Authorization: FortifyToken $fortify_unified_login_token")
              
              if [ "$method" = "POST" ] || [ "$method" = "PUT" ]; then
                  curl_opts+=(-X "$method")
                  if [ -n "$data" ]; then
                      curl_opts+=(-d "$data")
                  fi
              fi
              
              curl_opts+=("$url")
              
              local response
              local exit_code
              
              response=$(curl "${curl_opts[@]}" 2>/dev/null) || exit_code=$?
              
              if [ "${exit_code:-0}" -ne 0 ]; then
                  echo "‚ùå Falha na chamada API ($context): $exit_code"
                  return 1
              fi
              
              if ! validate_json_response "$response" "$context"; then
                  return 1
              fi
              
              echo "$response"
              return 0
          }
          
          # Buscar projeto/vers√£o
          project_response=$(api_call "GET" "$fortify_ssc_api_url/projectVersions?q=$fortify_project_name&fulltextsearch=true" "" "buscar projeto")
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Falha ao buscar projeto"
            exit 1
          fi
          
          # Buscar version_id
          version_id=$(echo "$project_response" | jq -r --arg proj "$fortify_project_name" --arg ver "$fortify_version_name" \
              '.data[] | select(.project.name==$proj and .name==$ver) | .id')
          
          if [ -z "$version_id" ] || [ "$version_id" == "null" ]; then
            echo "‚ùå Projeto/vers√£o n√£o encontrado: $fortify_project_name/$fortify_version_name"
            exit 1
          fi
          
          echo "‚úÖ Projeto encontrado: $version_id"
          
          # Buscar FPR
          artifacts_response=$(api_call "GET" "$fortify_ssc_api_url/projectVersions/$version_id/artifacts" "" "buscar artefatos")
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Falha ao buscar artefatos"
            exit 1
          fi
          
          # Buscar FPR
          fpr_id=$(echo "$artifacts_response" | jq -r '.data[] | select(.name | endswith(".fpr")) | .id' | head -1)
          
          if [ -z "$fpr_id" ] || [ "$fpr_id" == "null" ]; then
            echo "‚ùå Nenhum FPR encontrado"
            exit 1
          fi
          
          echo "‚úÖ FPR encontrado: $fpr_id"
          
          # Baixar FPR
          mkdir -p fortify-artifacts
          
          safe_project_name=$(echo "$fortify_project_name" | sed 's/[^a-zA-Z0-9._-]/-/g')
          if [[ -z "$safe_project_name" ]]; then
            safe_project_name="project"
          fi
          
          fpr_filename="${safe_project_name}-${fortify_version_name}.fpr"
          
          if ! curl -k -sSL --connect-timeout 30 --max-time 300 \
              -H "Authorization: FortifyToken $fortify_unified_login_token" \
              -H "Accept: application/octet-stream" \
              "$fortify_ssc_api_url/projectVersions/$version_id/artifacts/$fpr_id/content" \
              -o "fortify-artifacts/$fpr_filename"; then
            echo "‚ùå Falha ao baixar FPR"
            exit 1
          fi
          
          file_size=$(wc -c < "fortify-artifacts/$fpr_filename")
          if [ "$file_size" -lt 1024 ]; then
            echo "‚ùå Arquivo FPR muito pequeno"
            exit 1
          fi
          
          echo "‚úÖ FPR baixado: $fpr_filename ($((file_size/1024/1024))MB)"
          echo "fpr_filename=$fpr_filename" >> $GITHUB_ENV

      - name: Convert FPR to SARIF
        env:
          fortify_project_name: ${{ env.PROJECT_NAME }}
          fortify_version_name: ${{ env.PROJECT_VERSION }}
        run: |
          echo "üîÑ Convertendo FPR ‚Üí SARIF..."
          
          fpr_file="fortify-artifacts/$fpr_filename"
          sarif_file="fortify-artifacts/fortify-sast-results.sarif"
          
          if ! sarif convert "$fpr_file" \
                --tool FortifyFpr \
                --output "$sarif_file" \
                --pretty-print --force; then
            echo "‚ùå Falha na convers√£o"
            exit 1
          fi
          
          if [ ! -f "$sarif_file" ]; then
            echo "‚ùå Arquivo SARIF n√£o foi gerado"
            exit 1
          fi
          
          file_size=$(wc -c < "$sarif_file")
          findings=$(jq '.runs[0].results | length' "$sarif_file" 2>/dev/null || echo "0")
          
          echo "‚úÖ SARIF gerado: $((file_size/1024))KB, $findings findings"

      - name: Validate SARIF
        if: inputs.validate_sarif == 'true'
        run: |
          sarif_file="fortify-artifacts/fortify-sast-results.sarif"
          
          if [ ! -f "$sarif_file" ]; then
            echo "‚ùå Arquivo SARIF n√£o encontrado"
            exit 1
          fi
          
          if ! sarif validate "$sarif_file" 2>/dev/null; then
            echo "‚ùå SARIF inv√°lido"
            exit 1
          fi
          
          echo "‚úÖ SARIF v√°lido"

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: fortify-artifacts/fortify-sast-results.sarif
        continue-on-error: true

      - name: Upload SARIF Artifact
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874
        with:
          name: fortify-sarif-${{ github.run_number }}
          path: fortify-artifacts/fortify-sast-results.sarif
          if-no-files-found: error
          retention-days: 30 
