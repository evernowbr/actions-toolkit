name: Fortify FPR to SARIF Converter

permissions:
  contents: read
  actions: read
  security-events: write

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      version:
        required: true
        type: string
      polling_timeout_minutes:
        description: 'Timeout para aguardar FPR'
        required: false
        default: 45
        type: number
      sarif_multitool_version:
        description: 'Vers√£o espec√≠fica do SARIF MultiTool'
        required: false
        default: 'latest'
        type: string

    secrets:
      FORTIFY_SSC_API_URL:
        required: true
      FORTIFY_UNIFIED_LOGIN_TOKEN:
        required: true
      FORTIFY_CONTROLLER_URL:
        required: true
      FORTIFY_CONTROLLER_TOKEN:
        required: true

jobs:
  fortify-scan:
    name: Fortify Scan and Publish
    runs-on: self-hosted
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Mask sensitive data
        run: |
          echo "::add-mask::${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}"
          echo "::add-mask::${{ secrets.FORTIFY_CONTROLLER_TOKEN }}"

      - name: Validate inputs
        run: |
          echo "fortify_project_name=$(echo "${{ inputs.name }}" | sed 's/[^a-zA-Z0-9._/-]//g' | head -c 100)" >> $GITHUB_ENV
          echo "fortify_version_name=$(echo "${{ inputs.version }}" | sed 's/[^a-zA-Z0-9._/-]//g' | head -c 50)" >> $GITHUB_ENV
          echo "::notice title=Input Validation::Project: ${{ inputs.name }}, Version: ${{ inputs.version }}"

      - name: Verify dependencies
        run: |
          echo "::notice title=Dependencies::Checking required tools..."
          
          for cmd in jq curl awk sed; do
            if ! command -v "$cmd" >/dev/null 2>&1; then
              echo "::error title=Missing Dependency::$cmd not found. Install required tool."
              exit 1
            fi
          done
          
          echo "üîç Verificando scancentral..."
          if command -v scancentral >/dev/null 2>&1; then
            echo "::notice title=ScanCentral::Found scancentral in PATH"
          elif [ -f "/opt/Fortify_ScanCentral_Client_25.2.0_x64/bin/scancentral" ]; then
            echo "::notice title=ScanCentral::Found scancentral in /opt/Fortify_ScanCentral_Client_25.2.0_x64/bin/"
            export PATH="/opt/Fortify_ScanCentral_Client_25.2.0_x64/bin:$PATH"
          else
            echo "::error title=Missing ScanCentral::scancentral not found. Install Fortify ScanCentral Client or configure PATH."
            echo "üìã Locais verificados:"
            echo "   - PATH padr√£o"
            echo "   - /opt/Fortify_ScanCentral_Client_25.2.0_x64/bin/"
            echo "   - /usr/local/bin/"
            echo "   - /usr/bin/"
            exit 1
          fi
          
          echo "::notice title=Dependencies::All required tools found and configured"

      - name: Execute Fortify Scan
        env:
          fortify_project_name: ${{ inputs.name }}
          fortify_version_name: ${{ inputs.version }}
          fortify_ssc_api_url: ${{ secrets.FORTIFY_SSC_API_URL }}
          fortify_unified_login_token: ${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}
          fortify_controller_url: ${{ secrets.FORTIFY_CONTROLLER_URL }}
          fortify_controller_token: ${{ secrets.FORTIFY_CONTROLLER_TOKEN }}

        run: |
          echo "::notice title=Fortify Scan::Starting Fortify SAST scan execution"
          echo "::notice title=Environment::Project: $fortify_project_name, Version: $fortify_version_name"
          echo "üîß Configurando Fortify ScanCentral Client..."
          export PATH="/opt/Fortify_ScanCentral_Client_25.2.0_x64/bin:$PATH"
          echo "export PATH=\$PATH:/opt/Fortify_ScanCentral_Client_25.2.0_x64/bin" >> /home/github-runner/.bashrc
          source ~/.bashrc
          
          echo "üîç Verificando scancentral ap√≥s configura√ß√£o..."
          if ! command -v scancentral >/dev/null 2>&1; then
            echo "::error title=ScanCentral Configuration::scancentral not found after PATH configuration. Check installation."
            echo "üìã PATH atual: $PATH"
            exit 1
          fi
          echo "::notice title=ScanCentral::scancentral configured and ready"
          
          echo "::notice title=API Setup::Configuring Fortify SSC API connection"
          echo "::notice title=API Setup::SSC URL: $fortify_ssc_api_url"
          
          fortify_verificar_resposta_api() {
              local response="$1"
              local exit_code="$2"
              
              if [[ -z "$response" ]]; then
                  echo "::error title=API Error::Empty response from Fortify SSC API"
                  exit 1
              fi
              
              if ! echo "$response" | jq -e . >/dev/null 2>&1; then
                  echo "::error title=API Error::Invalid JSON response from Fortify SSC API"
                  echo "Response: $response"
                  exit 1
              fi
              
              local responseCode=$(echo "$response" | jq -r '.responseCode // empty')
              if [[ -n "$responseCode" ]] && [[ "$responseCode" != "200" ]] && [[ "$responseCode" != "201" ]]; then
                  local error_message=$(echo "$response" | jq -r '.message // "Unknown API error"')
                  echo "::error title=Fortify SSC API Error::HTTP $responseCode - $error_message. Check FORTIFY_SSC_API_URL and FORTIFY_UNIFIED_LOGIN_TOKEN."
                  echo "‚ùå C√≥digo de retorno diferente de 200: API retornou c√≥digo $responseCode"
                  echo "‚ùå Resposta da API: $response"
                  exit 1
              fi
              
              if [[ -n "$exit_code" ]] && [[ "$exit_code" != "0" ]]; then
                  echo "::error title=API Call Failed::Command returned exit code $exit_code"
                  echo "‚ùå Comando retornou $exit_code"
                  echo "‚ùå Mensagem de erro: $response"  
                  exit $exit_code
              fi
          }

          fortify_verificar_codigo_de_resposta() {
              if [[ "$exit_code" != "0" ]]; then
                  echo "::error title=ScanCentral Execution::scancentral command failed with exit code $exit_code"
                  echo "‚ùå Comando retornou $exit_code"
                  exit $exit_code
              fi
          }
          
          fortify_criar_projeto_e_versao() {
              echo "::notice title=Project Creation::Creating new project $fortify_project_name with version $fortify_version_name"
              fortify_project_parameters='{"project":{"name":"'$fortify_project_name'"},"issueTemplateId":"Prioritized-HighRisk-Project-Template","name":"'$fortify_version_name'","customTagValuesAutoApply":true,"autoPredict":true,"predictionPolicy":"LAB Fortify Policy"}'
              response=$(curl -sS -k -X POST --header "Content-Type: application/json" --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/projectVersions" -d "$fortify_project_parameters")
              exit_code=$?
              fortify_verificar_resposta_api "$response" "$exit_code"
              project_id=$(echo "$response" | jq '.data.project.id')
              version_id=$(echo "$response" | jq '.data.id')
              echo "::notice title=Project Created::Project $fortify_project_name created with ID $project_id"
              echo "::notice title=Version Created::Version $fortify_version_name created with ID $version_id"
          }
          
          fortify_criar_versao() {
              echo "::notice title=Version Creation::Creating new version $fortify_version_name for existing project"
              fortify_project_parameters='{"project":{"name":"'$fortify_project_name'","id":"'$project_id'"},"issueTemplateId":"Prioritized-HighRisk-Project-Template","name": "'$fortify_version_name'"}'
              response=$(curl -sS -k -X POST --header "Content-Type: application/json" --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/projectVersions" -d "$fortify_project_parameters")
              exit_code=$?
              fortify_verificar_resposta_api "$response" "$exit_code"
              version_id=$(echo "$response" | jq '.data.id')
              echo "::notice title=Version Created::Version $fortify_version_name created with ID $version_id"
          }
          
          fortify_configurar_projeto() {
              echo "::notice title=Project Configuration::Configuring project attributes and settings"
              fortify_parametros='{"requests":[{"uri":"'$fortify_ssc_api_url/projectVersions/$version_id/attributes'","httpVerb":"PUT","postData":[{"values":[{"guid":"New"}],"attributeDefinitionId":5},{"values":[{"guid":"Internal"}],"attributeDefinitionId":6},{"values":[{"guid":"internalnetwork"}],"attributeDefinitionId":7}]},{"uri":"'$fortify_ssc_api_url/projectVersions/$version_id/authEntities'","httpVerb":"PUT","postData":[]},{"uri":"'$fortify_ssc_api_url/projectVersions/$version_id?hideProgress=true'","httpVerb":"PUT","postData":{"committed":true}}]}'
              response=$(curl -sS -k -X POST --header "Content-Type: application/json" --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/bulk" -d "$fortify_parametros")
              exit_code=$?
              fortify_verificar_resposta_api "$response" "$exit_code"
              successCount=$(echo "$response" | jq '.successCount')
              if [[ "$successCount" != "3" ]]; then
                  echo "::error title=Project Configuration Failed::Only $successCount/3 configuration steps succeeded"
                  echo "‚ùå Par√¢metros adicionais do projeto $fortify_project_name configurados sem sucesso."
                  echo "‚ùå C√≥digo de retorno diferente de 200: API retornou c√≥digo $exit_code"
                  echo "‚ùå Resposta da API: $response"
                  exit 1
              else
                  echo "::notice title=Project Configuration::Project attributes configured successfully"
              fi
          }
          
          fortify_regras_processamento() {
              echo "::notice title=Processing Rules::Configuring result processing rules"
              response=$(curl -sS -k -X PUT --header "Content-Type: application/json" --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/projectVersions/$version_id/resultProcessingRules" -d '[{"identifier": "com.fortify.manager.BLL.processingrules.BuildProjectProcessingRule","displayName": "Require approval if the Build Project is different between scans","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.FileCountProcessingRule","displayName": "Require approval if file count differs by more than 10%","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.LOCCountProcessingRule","displayName": "Require approval if line count differs by more than 10%","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.NewerEngineVersionProcessingRule","displayName": "Require approval if the engine version of a scan is newer than the engine version of the previous scan","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.RulePackVersionProcessingRule","displayName": "Require approval if the rulepacks used in the scan do not match the rulepacks used in the previous scan","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.WarningProcessingRule","displayName": "Require approval if result has analysis warnings","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.ExternalListVersionProcessingRule","displayName": "Check external metadata file versions in scan against versions on server.","displayable": true,"enabled": false}]')
              exit_code=$?
              fortify_verificar_resposta_api "$response" "$exit_code"
              echo "::notice title=Processing Rules::Result processing rules configured successfully"
          }
          
          echo '   ____            __   _  ___        ____ ___    ____ ______ '
          echo '  / __/___   ____ / /_ (_)/ _/__ __  / __// _ |  / __//_  __/ '
          echo ' / _/ / _ \ / __// __// // _// // / _\ \ / __ | _\ \   / /    ' 
          echo '/_/   \___//_/   \__//_//_/  \_, / /___//_/ |_|/___/  /_/     '
          echo '                            /___/                             '
          
          echo "::notice title=Project Check::Checking if project $fortify_project_name exists in SSC"
          echo "üîç Verificando se o projeto $fortify_project_name existe no SSC..."
          response=$(curl -sS -k -X GET --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/projectVersions?q=$fortify_project_name&fulltextsearch=true")
          exit_code=$?
          fortify_verificar_resposta_api "$response" "$exit_code"
          echo "::notice title=API Response::Project check completed successfully"
          project_id=$(echo "$response" | jq '.data[] | select(.project.name=="'$fortify_project_name'") | .project.id' | head -1 | awk '{$1=$1};1')
          version_id=$(echo "$response" | jq '.data[] | select(.project.name=="'$fortify_project_name'") | select(.name=="'$fortify_version_name'") | .id' | awk '{$1=$1};1')
          echo "::notice title=Project Status::Project ID: $project_id, Version ID: $version_id"
          
          if [[ "$version_id" != "" ]]; then
              echo "::notice title=Project Status::Project $fortify_project_name exists with ID $project_id"
              echo "::notice title=Version Status::Version $fortify_version_name exists with ID $version_id"
          elif [[ "$project_id" != "" ]]; then
              echo "::notice title=Project Status::Project $fortify_project_name exists with ID $project_id"
              echo "::notice title=Version Status::Creating new version $fortify_version_name"
              fortify_criar_versao
          else
              echo "::notice title=Project Status::Creating new project $fortify_project_name and version $fortify_version_name"
              fortify_criar_projeto_e_versao
          fi
          
          fortify_configurar_projeto
          fortify_regras_processamento
          
          echo "::notice title=Scan Preparation::All configuration completed, starting scancentral"
          echo "üîß Executando Scancentral Client"
          echo "::notice title=Scan Execution::Starting Fortify SAST scan"
          scan_output=$(scancentral -ssctoken "$fortify_controller_token" -url "$fortify_controller_url" start -skipBuild -block --log-file fortify.log --overwrite -application "$fortify_project_name" -version "$fortify_version_name" --upload-to-ssc --ssc-upload-token "$fortify_controller_token" 2>&1 | tee /dev/stderr)
          
          exit_code=$?
          fortify_verificar_codigo_de_resposta
          
          job_token=$(echo "$scan_output" | grep "Submitted job and received token" | grep -E -o "[a-f0-9-]{36}")
          
          if [[ -z "$job_token" ]]; then
              echo "::error title=Scan Failed::Job token not created. Check scancentral output for errors."
              echo "‚ùå Job token n√£o foi criado."
              exit 1
          else
              echo "::notice title=Scan Success::Files submitted for scan with job token: $job_token"
          fi
          
          echo "‚öôÔ∏è Iniciando processamento das regras de gate para o projeto."
          
          regras_json='[
            {
              "gate": "audited:false [fortify priority order]:critical [fortify priority order]:high",
              "name": "default",
              "bypass": "false"
            },
            {
              "gate": "audited:false [fortify priority order]:critical [fortify priority order]:high",
              "name": "teste",
              "bypass": "true"
            }
          ]'
          
          gate=$(echo "$regras_json" | jq --compact-output --raw-output '.[] | select(.name=="default") | .gate')
          if [[ -z "$gate" ]]; then
              echo "::error title=Gate Configuration::No 'default' rule defined for project"
              echo "‚ùå Nenhuma regra 'default' foi definida para o projeto no Fortify."
              exit 1
          fi
          
          bypass=$(echo "$regras_json" | jq --compact-output --raw-output '.[] | select(.name=="default") | .bypass')
          filtro_aplicado="$gate"
          
          if [[ "$bypass" == "true" ]]; then
              echo "::warning title=Gate Bypass::Default gate rule bypassed - pipeline continuation allowed"
              echo "‚ö†Ô∏è  Bypass ativado: a regra 'default' n√£o ser√° aplicada."
              echo "‚úÖ Continua√ß√£o do pipeline permitida."
          else
              echo "::notice title=Gate Check::Applying default gate rule: $filtro_aplicado"
              echo "üîí Bypass desativado: a regra 'default' ser√° aplicada."
              echo "üîç Filtro aplicado: \`$filtro_aplicado\`"
              filtro_url_encoded=$(echo "$filtro_aplicado" | jq -sRr '@uri')
              echo "üì° Consultando vulnerabilidades no Fortify SSC..."
          
              response=$(curl -sS -k -X GET --header 'Content-Type: application/json' \
                  --header 'Accept: application/json' \
                  --header "Authorization: FortifyToken $fortify_unified_login_token" \
                  "$fortify_ssc_api_url/projectVersions/$version_id/issues?qm=issues&q=$filtro_url_encoded")
              exit_code=$?
          
              fortify_verificar_resposta_api "$response" "$exit_code"
          
              num_issues=$(echo "$response" | jq '.count')
          
              if [[ "$num_issues" -gt 0 ]]; then
                  echo "::error title=Gate Failed::$num_issues vulnerabilities found. Pipeline blocked."
                  echo "‚ùå Gate falhou: **$num_issues** vulnerabilidades encontradas com base no filtro aplicado."
                  echo "üìÑ Verifique o relat√≥rio detalhado acima para mais informa√ß√µes."
                  echo '  _____       __         ____       _  __ '
                  echo ' / ___/___ _ / /_ ___   / __/___ _ (_)/ / '
                  echo '/ (_ // _ `// __// -_) / _/ / _ `// // /  '
                  echo '\___/ \_,_/ \__/ \__/ /_/   \_,_//_//_/   '
                  exit 1
              else
                  echo "::notice title=Gate Passed::No critical or high vulnerabilities found. Pipeline authorized."
                  echo "‚úÖ Gate aprovado: Nenhuma vulnerabilidade cr√≠tica ou alta encontrada."
                  echo "üöÄ Continua√ß√£o do build autorizada."
                  echo '  _____       __         ___                 '
                  echo ' / ___/___ _ / /_ ___   / _ \ ___ _ ___  ___ '
                  echo '/ (_ // _ `// __// -_) / ___// _ `/(_-< (_-< '
                  echo '\___/ \_,_/ \__/ \__/ /_/    \_,_//___//___/ '
              fi
          fi
          
          mkdir -p /tmp/fortify-metadata
          echo "$version_id" > /tmp/fortify-metadata/version_id
          echo "$job_token" > /tmp/fortify-metadata/job_token
          echo "$fortify_project_name" > /tmp/fortify-metadata/project_name
          echo "$fortify_version_name" > /tmp/fortify-metadata/version_name

      - name: Upload scan metadata
        uses: actions/upload-artifact@v4
        with:
          name: fortify-metadata-${{ github.run_number }}
          path: /tmp/fortify-metadata/
          retention-days: 2
          if-no-files-found: error

      - name: Create scan summary
        if: always()
        run: |
          if [ -f /tmp/fortify-metadata/version_id ]; then
            echo "## ‚úÖ Fortify SAST Scan Summary" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Scan | ‚úÖ SUCCESS |" >> $GITHUB_STEP_SUMMARY
            echo "| SSC Upload | ‚úÖ SUCCESS |" >> $GITHUB_STEP_SUMMARY
            echo "| Gate Check | ‚úÖ PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Project:** $(cat /tmp/fortify-metadata/project_name)" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** $(cat /tmp/fortify-metadata/version_name)" >> $GITHUB_STEP_SUMMARY
            echo "**Job Token:** $(cat /tmp/fortify-metadata/job_token)" >> $GITHUB_STEP_SUMMARY
            echo "**Version ID:** $(cat /tmp/fortify-metadata/version_id)" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Fortify SAST Scan Failed" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** FAILED" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Check logs for specific error details" >> $GITHUB_STEP_SUMMARY
          fi

  convert-fpr-sarif:
    name: Download FPR and Convert to SARIF
    runs-on: ubuntu-latest
    needs: fortify-scan
    timeout-minutes: ${{ inputs.polling_timeout_minutes }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "::notice title=Dependencies::Installing required packages"
          sudo apt-get update -qq
          sudo apt-get install -y jq curl >/dev/null 2>&1
          echo "::notice title=Dependencies::All packages installed successfully"

      - name: Download scan metadata
        uses: actions/download-artifact@v4
        with:
          name: fortify-metadata-${{ github.run_number }}
          path: /tmp/fortify-metadata/

      - name: Load metadata
        run: |
          echo "VERSION_ID=$(cat /tmp/fortify-metadata/version_id)" >> $GITHUB_ENV
          echo "JOB_TOKEN=$(cat /tmp/fortify-metadata/job_token)" >> $GITHUB_ENV
          echo "fortify_project_name=$(cat /tmp/fortify-metadata/project_name)" >> $GITHUB_ENV
          echo "fortify_version_name=$(cat /tmp/fortify-metadata/version_name)" >> $GITHUB_ENV
          echo "::notice title=Metadata::Loaded scan metadata successfully"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Cache .NET tools
        uses: actions/cache@v4
        with:
          path: ~/.dotnet/tools
          key: dotnet-tools-${{ inputs.sarif_multitool_version }}-${{ runner.os }}
          restore-keys: |
            dotnet-tools-${{ runner.os }}-

      - name: Install SARIF MultiTool
        run: |
          echo "::notice title=SARIF MultiTool::Installing SARIF MultiTool version ${{ inputs.sarif_multitool_version }}"
          command -v sarif >/dev/null 2>&1 || dotnet tool install --global Sarif.Multitool --version ${{ inputs.sarif_multitool_version }} --no-cache 2>/dev/null
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
          echo "::notice title=SARIF MultiTool::Installation completed"

      - name: Download FPR
        env:
          fortify_ssc_api_url: ${{ secrets.FORTIFY_SSC_API_URL }}
          fortify_unified_login_token: ${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}
        run: |
          echo "::notice title=FPR Download::Starting FPR download with timeout of ${{ inputs.polling_timeout_minutes }} minutes"
          
          for attempt in $(seq 1 ${{ inputs.polling_timeout_minutes }}); do
              echo "::notice title=FPR Download::Attempt $attempt/${{ inputs.polling_timeout_minutes }} - Checking for FPR artifacts"
              
              artifacts_response=$(curl -sS -k -X GET \
                  --connect-timeout 30 \
                  --max-time 120 \
                  -H "Accept: application/json" \
                  -H "Authorization: FortifyToken $fortify_unified_login_token" \
                  "$fortify_ssc_api_url/projectVersions/$VERSION_ID/artifacts" 2>/dev/null)
              
              if [[ $? -eq 0 ]] && echo "$artifacts_response" | jq -e . >/dev/null 2>&1; then
                  fpr_id=$(echo "$artifacts_response" | jq -r '.data[]? | select(.name? | test("\\.fpr$")) | .id' | head -1)
                  
                  if [[ -n "$fpr_id" ]] && [[ "$fpr_id" != "null" ]]; then
                      echo "::notice title=FPR Download::FPR artifact found with ID: $fpr_id"
                      mkdir -p fortify-artifacts
                      fpr_filename="$fortify_project_name-${fortify_version_name}.fpr"
                      
                      echo "::notice title=FPR Download::Downloading FPR file: $fpr_filename"
                      curl -sS -k -L \
                          --connect-timeout 60 \
                          --max-time 600 \
                          -H "Authorization: FortifyToken $fortify_unified_login_token" \
                          -H "Accept: application/octet-stream" \
                          "$fortify_ssc_api_url/projectVersions/$VERSION_ID/artifacts/$fpr_id/content" \
                          -o "fortify-artifacts/$fpr_filename"
                      
                      if [[ -f "fortify-artifacts/$fpr_filename" ]] && [[ $(wc -c < "fortify-artifacts/$fpr_filename") -gt 1024 ]]; then
                          fpr_size=$(wc -c < "fortify-artifacts/$fpr_filename")
                          echo "::notice title=FPR Download::FPR downloaded successfully - Size: $fpr_size bytes"
                          echo "FPR_FILE=fortify-artifacts/$fpr_filename" >> $GITHUB_ENV
                          echo "FPR_FILENAME=$fpr_filename" >> $GITHUB_ENV
                          break
                      else
                          echo "::warning title=FPR Download::FPR file too small or empty - Size: $(wc -c < "fortify-artifacts/$fpr_filename" 2>/dev/null || echo 0) bytes"
                      fi
                  else
                      echo "::notice title=FPR Download::No FPR artifact found yet - Attempt $attempt/${{ inputs.polling_timeout_minutes }}"
                  fi
              else
                  echo "::warning title=FPR Download::Failed to retrieve artifacts - Attempt $attempt/${{ inputs.polling_timeout_minutes }}"
              fi
              
              if [[ $attempt -lt ${{ inputs.polling_timeout_minutes }} ]]; then
                  echo "::notice title=FPR Download::Waiting 60 seconds before next attempt"
                  sleep 60
              else
                  echo "::error title=FPR Download Timeout::FPR download timed out after ${{ inputs.polling_timeout_minutes }} minutes"
                  exit 1
              fi
          done

      - name: Convert to SARIF
        run: |
          echo "::notice title=SARIF Conversion::Starting FPR to SARIF conversion"
          
          if [[ ! -f "$FPR_FILE" ]]; then
              echo "::error title=SARIF Conversion::FPR file not found: $FPR_FILE"
              exit 1
          fi
          
          echo "::notice title=SARIF Conversion::Converting $FPR_FILENAME to SARIF format"
          timeout 300 sarif convert "$FPR_FILE" --tool FortifyFpr --output "fortify-artifacts/fortify-sast-results.sarif" --pretty-print --force 2>/dev/null || true
          
          if [[ -f "fortify-artifacts/fortify-sast-results.sarif" ]] && [[ -s "fortify-artifacts/fortify-sast-results.sarif" ]]; then
              echo "::notice title=SARIF Conversion::SARIF conversion completed successfully"
          else
              echo "::warning title=SARIF Conversion::SARIF conversion failed, creating fallback SARIF"
              jq -n '{"$schema":"https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0-rtm.5.json","version":"2.1.0","runs":[{"tool":{"driver":{"name":"Fortify Static Code Analyzer","version":"25.2.0"}},"results":[]}]}' > "fortify-artifacts/fortify-sast-results.sarif"
          fi
          
          echo "::notice title=SARIF Conversion::Adding metadata to SARIF"
          jq --arg project "$fortify_project_name" \
             --arg version "$fortify_version_name" \
             --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
             --arg job_token "$JOB_TOKEN" \
             --arg version_id "$VERSION_ID" \
             --arg fpr_file "$FPR_FILENAME" \
             '(.runs[0].properties // {}) |= . + {
                "fortify_project": $project,
                "fortify_version": $version,
                "fortify_scan_time": $timestamp,
                "fortify_job_token": $job_token,
                "fortify_version_id": $version_id,
                "fortify_engine_version": "25.2.0",
                "fortify_fpr_file": $fpr_file,
                "conversion_method": "optimized_fpr_to_sarif",
                "github_run_id": "'${{ github.run_id }}'",
                "github_run_number": "'${{ github.run_number }}'"
              }' "fortify-artifacts/fortify-sast-results.sarif" > "fortify-artifacts/fortify-sast-results.sarif.tmp" && mv "fortify-artifacts/fortify-sast-results.sarif.tmp" "fortify-artifacts/fortify-sast-results.sarif"

      - name: Validate SARIF
        run: |
          echo "::notice title=SARIF Validation::Validating SARIF file"
          
          if [[ ! -f "fortify-artifacts/fortify-sast-results.sarif" ]]; then
              echo "::error title=SARIF Validation::SARIF file not found"
              exit 1
          fi
          
          if ! jq -e . "fortify-artifacts/fortify-sast-results.sarif" >/dev/null 2>&1; then
              echo "::error title=SARIF Validation::SARIF file contains invalid JSON"
              exit 1
          fi
          
          findings_count=$(jq '.runs[0].results | length' "fortify-artifacts/fortify-sast-results.sarif" 2>/dev/null || echo "0")
          echo "::notice title=SARIF Validation::SARIF validation passed - $findings_count findings found"

      - name: Upload to Code Scanning
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: fortify-artifacts/fortify-sast-results.sarif
        continue-on-error: true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortify-sarif-${{ github.run_number }}
          path: fortify-artifacts/fortify-sast-results.sarif
          if-no-files-found: error
          retention-days: 30
        if: always()

      - name: Create summary
        run: |
          echo "# Fortify FPR ‚Üí SARIF Conversion Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Findings | $(jq '.runs[0].results | length' "fortify-artifacts/fortify-sast-results.sarif" 2>/dev/null || echo "0") |" >> $GITHUB_STEP_SUMMARY
          echo "| Project | $fortify_project_name |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $fortify_version_name |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download: Actions ‚Üí This run ‚Üí Artifacts ‚Üí fortify-sarif-${{ github.run_number }}.zip" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        uses: geekyeggo/delete-artifact@v5
        with:
          name: fortify-metadata-${{ github.run_number }}
        continue-on-error: true
        if: always() 
