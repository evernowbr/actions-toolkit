name: Fortify SAST

on:
    workflow_call:
        inputs:
            name:
                required: true
                type: string
            version:
                required: true
                type: string
            fortify_scancentral_tool:
                required: true
                type: string
            fortify_translate_name:
                required: true
                type: string
            fortify_translate_additional_flags:
                required: true
                type: string
        secrets:
            FORTIFY_SSC_API_URL:
                required: true
            FORTIFY_UNIFIED_LOGIN_TOKEN:
                required: true
            FORTIFY_CONTROLLER_URL:
                required: true
            FORTIFY_CONTROLLER_TOKEN:
                required: true

jobs:
    scan:
        name: Fortify SAST
        runs-on: self-hosted

        steps:
            - name: Checkout do reposit√≥rio
              uses: actions/checkout@v4
                  
            - name: Run Scan
              env:
                  fortify_project_name: ${{ inputs.name }}
                  fortify_version_name: ${{ inputs.version }}
                  fortify_translate_name: ${{ inputs.fortify_translate_name }}
                  fortify_scancentral_tool: ${{ inputs.fortify_scancentral_tool }}
                  fortify_translate_additional_flags: ${{ inputs.fortify_translate_additional_flags }}
                  fortify_ssc_api_url: ${{ secrets.FORTIFY_SSC_API_URL }}
                  fortify_unified_login_token: ${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}
                  fortify_controller_url: ${{ secrets.FORTIFY_CONTROLLER_URL }}
                  fortify_controller_token: ${{ secrets.FORTIFY_CONTROLLER_TOKEN }}
              run: |
                  echo "Executando Fortify SAST"
                  export PATH="$PATH:/opt/Fortify_ScanCentral_Client_25.2.0_x64/bin"

                  fortify_verificar_resposta_api() {
                      if [ "$exit_code" == "0" ] || [ "$exit_code" == "" ]; then
                          responseCode=$(echo "$response" | jq '.responseCode')
                          if [ "$responseCode" != "200" ] && [ "$responseCode" != "201" ]; then
                              echo "‚ùå C√≥digo de retorno diferente de 200: API retornou c√≥digo $responseCode"
                              echo "‚ùå Resposta da API: $response"
                              exit 1
                          fi
                      else
                          echo "‚ùå Comando retornou $exit_code"
                          echo "‚ùå Mensagem de erro: $response"  
                          exit $exit_code
                      fi
                  }

                  fortify_verificar_codigo_de_resposta() {
                  	if [ "$exit_code" != "0" ]; then
                  		echo "‚ùå Comando retornou $exit_code"
                  		exit $exit_code
                  	fi
                  }

                  fortify_criar_projeto_e_versao() {
                      # Cria um projeto e uma vers√£o novos
                      fortify_project_parameters='{"project":{"name":"'$fortify_project_name'"},"issueTemplateId":"Prioritized-HighRisk-Project-Template","name":"'$fortify_version_name'","customTagValuesAutoApply":true,"autoPredict":true,"predictionPolicy":"LAB Fortify Policy"}'
                      response=$(curl -sS -k -X POST --header "Content-Type: application/json" --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/projectVersions" -d "$fortify_project_parameters")
                      exit_code=$?
                      fortify_verificar_resposta_api
                      fortify_project_id=$(echo "$response" | jq '.data.project.id')
                      fortify_project_version_id=$(echo "$response" | jq '.data.id')
                      echo "‚úÖ Projeto $fortify_project_name criado com ID $fortify_project_id."
                      echo "‚úÖ Vers√£o $fortify_version_name criada com ID $fortify_project_version_id."
                  }

                  fortify_criar_versao() {
                      # Cria uma vers√£o para um projeto j√° existente
                      fortify_project_parameters='{"project":{"name":"'$fortify_project_name'","id":"'$fortify_project_id'"},"issueTemplateId":"Prioritized-HighRisk-Project-Template","name": "'$fortify_version_name'"}'
                      response=$(curl -sS -k -X POST --header "Content-Type: application/json" --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/projectVersions" -d "$fortify_project_parameters")
                      exit_code=$?
                      fortify_verificar_resposta_api
                      fortify_project_version_id=$(echo "$response" | jq '.data.id')
                      echo "‚úÖ Vers√£o $fortify_version_name criada com ID $fortify_project_version_id."
                  }

                  fortify_configurar_projeto() {
                  # Configurar par√¢metros adicionais do projeto
                  fortify_parametros='{"requests":[{"uri":"'$fortify_ssc_api_url/projectVersions/$fortify_project_version_id/attributes'","httpVerb":"PUT","postData":[{"values":[{"guid":"New"}],"attributeDefinitionId":5},{"values":[{"guid":"Internal"}],"attributeDefinitionId":6},{"values":[{"guid":"internalnetwork"}],"attributeDefinitionId":7}]},{"uri":"'$fortify_ssc_api_url/projectVersions/$fortify_project_version_id/authEntities'","httpVerb":"PUT","postData":[]},{"uri":"'$fortify_ssc_api_url/projectVersions/$fortify_project_version_id?hideProgress=true'","httpVerb":"PUT","postData":{"committed":true}}]}'
                  response=$(curl -sS -k -X POST --header "Content-Type: application/json" --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/bulk" -d "$fortify_parametros")
                  exit_code=$?
                  fortify_verificar_resposta_api
                  successCount=$(echo "$response" | jq '.successCount')
                  if [ "$successCount" != "3" ]; then
                      echo "‚ùå Par√¢metros adicionais do projeto $fortify_project_name configurados sem sucesso."
                      echo "‚ùå C√≥digo de retorno diferente de 200: API retornou c√≥digo $exit_code"
                      echo "‚ùå Resposta da API: $response"
                      exit 1
                  else
                      echo "‚úÖ Par√¢metros adicionais do projeto $fortify_project_name configurados com sucesso."
                  fi
                  }

                  fortify_regras_processamento() {
                  # Definir regras de processamento de resultados
                  response=$(curl -sS -k -X PUT --header "Content-Type: application/json" --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/projectVersions/$fortify_project_version_id/resultProcessingRules" -d '[{"identifier": "com.fortify.manager.BLL.processingrules.BuildProjectProcessingRule","displayName": "Require approval if the Build Project is different between scans","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.FileCountProcessingRule","displayName": "Require approval if file count differs by more than 10%","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.LOCCountProcessingRule","displayName": "Require approval if line count differs by more than 10%","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.NewerEngineVersionProcessingRule","displayName": "Require approval if the engine version of a scan is newer than the engine version of the previous scan","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.RulePackVersionProcessingRule","displayName": "Require approval if the rulepacks used in the scan do not match the rulepacks used in the previous scan","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.WarningProcessingRule","displayName": "Require approval if result has analysis warnings","displayable": true,"enabled": false},{"identifier": "com.fortify.manager.BLL.processingrules.ExternalListVersionProcessingRule","displayName": "Check external metadata file versions in scan against versions on server.","displayable": true,"enabled": false}]')
                  exit_code=$?
                  fortify_verificar_resposta_api
                  echo "‚úÖ Regras de processamento do projeto $fortify_project_name configuradas com sucesso."
                  }
                  
                  # ========== EXECU√á√ÉO PRINCIPAL ==========
                  
                  echo '   ____            __   _  ___        ____ ___    ____ ______ '
                  echo '  / __/___   ____ / /_ (_)/ _/__ __  / __// _ |  / __//_  __/ '
                  echo ' / _/ / _ \ / __// __// // _// // / _\ \ / __ | _\ \   / /    ' 
                  echo '/_/   \___//_/   \__//_//_/  \_, / /___//_/ |_|/___/  /_/     '
                  echo '                            /___/                             '
                  
                  # Verificar se projeto e vers√£o j√° existem
                  echo "üîç Verificando se o projeto $fortify_project_name existe no SSC..."
                  response=$(curl -sS -k -X GET --header "Accept: application/json" --header "Authorization: FortifyToken $fortify_unified_login_token" "$fortify_ssc_api_url/projectVersions?q=$fortify_project_name&fulltextsearch=true")
                  exit_code=$?
                  fortify_verificar_resposta_api
                  fortify_project_id=$(echo "$response" | jq '.data[] | select(.project.name=="'$fortify_project_name'") | .project.id' | head -1 | awk '{$1=$1};1')
                  fortify_project_version_id=$(echo "$response" | jq '.data[] | select(.project.name=="'$fortify_project_name'") | select(.name=="'$fortify_version_name'") | .id' | awk '{$1=$1};1')
                  
                  if [ "$fortify_project_version_id" != "" ]; then
                      # J√° existe projeto e vers√£o no SSC
                      echo "‚úÖ O projeto $fortify_project_name j√° existe no SSC com ID $fortify_project_id."
                      echo "‚úÖ A vers√£o $fortify_version_name j√° existe no SSC com ID $fortify_project_version_id."
                  elif [ "$fortify_project_id" != "" ]; then
                      # J√° existe projeto (sem vers√£o) no SSC
                      echo "‚úÖ O projeto $fortify_project_name j√° existe no SSC com ID $fortify_project_id. Criando vers√£o..."
                      fortify_criar_versao
                  else
                      # N√£o tem projeto nem vers√£o no SSC
                      echo "‚ö†Ô∏è  O projeto $fortify_project_name ainda n√£o existe no SSC. Criando projeto e vers√£o..."
                      fortify_criar_projeto_e_versao
                  fi
                  
                  fortify_configurar_projeto
                  fortify_regras_processamento
                  
                  echo "üîß Executando Scancentral Client"
                  output=$($fortify_scancentral_tool -ssctoken $fortify_controller_token -url $fortify_controller_url start -sargs "-Xmx2G" -skipBuild -block --log-file fortify.log --overwrite -application $fortify_project_name -version $fortify_version_name --upload-to-ssc --ssc-upload-token $fortify_controller_token 2>&1 | tee /dev/stderr )                    
                  
                  # Verifica o c√≥digo de resposta
                  exit_code=$?
                  fortify_verificar_codigo_de_resposta
                    
                    # Extrai o job token da sa√≠da usando grep e regex
                    fortify_job_token=$(echo "$output" | grep "Submitted job and received token" | grep -E -o "[a-f0-9-]{36}")
                    
                    # Verifica se o job token foi encontrado
                    if [ -z "$fortify_job_token" ]; then
                        echo "‚ùå Job token n√£o foi criado."
                        exit 1
                    else
                        echo "‚úÖ Arquivos para scan enviados com sucesso. ID do Scan: $fortify_job_token"
                    fi

                    echo "üè∑Ô∏è  Iniciando git blame e set tag author"
                    # ==========================
                    # Verifica se a tag Author existe
                    # ==========================
                    echo "üîç Verificando custom tags no Fortify..."

                    response=$(curl -s -w "%{http_code}" -H "Authorization: FortifyToken $fortify_unified_login_token" \
                    "$fortify_ssc_api_url/customTags?start=0&limit=100&q=hidden%3Afalse")

                    code="${response: -3}"
                    body="${response::-3}"

                    [ "$code" != "200" ] && echo "‚ùå Erro HTTP $code" && exit 1
                    echo "$body" | jq empty >/dev/null 2>&1 || { echo "‚ùå JSON inv√°lido"; exit 1; }

                    guid=$(echo "$body" | jq -r '.data[] | select(.name=="Author" and .customTagType=="CUSTOM") | .guid')
                    if [ -z "$guid" ]; then
                        echo "‚ö†Ô∏è  Tag 'Author' com tipo 'CUSTOM' n√£o encontrada."
                        exit 1
                    fi
                    echo "‚úÖ Tag 'Author' encontrada! GUID: $guid"

                    # ==========================
                    # Verifica se a tag Author j√° est√° aplicada ao projeto
                    # ==========================
                    echo "üîç Verificando se a tag Author est√° aplicada ao projeto..."

                    response=$(curl -s -w "%{http_code}" -H "Authorization: FortifyToken $fortify_unified_login_token" \
                    "$fortify_ssc_api_url/projectVersions/$fortify_project_version_id/customTags?start=0&limit=100")

                    code="${response: -3}"
                    body="${response::-3}"

                    [ "$code" != "200" ] && echo "‚ùå Erro HTTP $code" && exit 1
                    echo "$body" | jq empty >/dev/null 2>&1 || { echo "‚ùå JSON inv√°lido"; exit 1; }

                    echo "üìã Tags atualmente aplicadas ao projeto:"
                    echo "$body" | jq -r '.data[] | "GUID: \(.guid)  Nome: \(.name // "N/A")  Tipo: \(.customTagType // "N/A")"'

                    aplicada=$(echo "$body" | jq -r --arg guid "$guid" '.data[] | select(.guid==$guid) | .guid')
                    if [ -n "$aplicada" ]; then
                        echo "‚úÖ A tag Author j√° est√° habilitada no projeto."
                    else
                        echo "‚öôÔ∏è  A tag Author ainda n√£o est√° habilitada. Aplicando..."
                        payload=$(echo "$body" | jq -r '.data[].guid' | jq -R . | jq -s 'map({guid:.})' | jq --arg guid "$guid" '. + [{"guid":$guid}]')
                        curl -s -X PUT -H "Authorization: FortifyToken $fortify_unified_login_token" \
                            -H "Content-Type: application/json" -d "$payload" \
                            "$fortify_ssc_api_url/projectVersions/$fortify_project_version_id/customTags"
                        echo "‚úÖ Tag Author aplicada com sucesso!"
                    fi

                    # ==========================
                    # Baixa issues do Fortify
                    # ==========================
                    responseIssues=$(curl -s -g \
                        -X GET "$fortify_ssc_api_url/projectVersions/$fortify_project_version_id/issues?orderby=id" \
                        -H "Accept: application/json" -H "Content-Type: application/json" \
                        -H "Authorization: FortifyToken $fortify_unified_login_token")

                    VULN_FILE="./fortify_vulnerabilities.json"
                    echo "$responseIssues" > "$VULN_FILE"

                    # ==========================
                    # Processa cada vulnerabilidade cr√≠tica/alta e aplica tag Author
                    # ==========================
                    jq -c '.data[] | select((.enginePriority=="Critical" or .enginePriority=="High") and (.issueStatus=="Unreviewed" or .primaryTag=="Exploitable"))' "$VULN_FILE" |
                    while read -r issue; do
                        issueId=$(echo "$issue" | jq -r '.id')
                        filePath=$(echo "$issue" | jq -r '.fullFileName')
                        lineNumber=$(echo "$issue" | jq -r '.lineNumber')
                        fixedPath="${filePath#./}"
                        authorMail="N/A"
                        if [ -f "$fixedPath" ] && [ "$lineNumber" != "null" ] && [ "$lineNumber" -gt 0 ]; then
                            blameOutput=$(git blame -L "$lineNumber,$lineNumber" --porcelain "$fixedPath" 2>/dev/null)
                            foundMail=$(echo "$blameOutput" | grep '^author-mail' | head -n 1 | cut -d' ' -f2 | sed 's/[<>]//g')
                            [ -n "$foundMail" ] && authorMail="$foundMail"
                        fi
                        echo "üìù Issue ID: $issueId  Arquivo: $filePath  Linha: $lineNumber  Autor: $authorMail"

                        payloadAuthor=$(jq -n --arg id "$issueId" --arg rev "$(echo "$issue" | jq -r '.revision')" \
                            --arg guid "$guid" --arg email "$authorMail" \
                            '{
                                type: "AUDIT_ISSUE",
                                values: {
                                    issues: [{id: ($id|tonumber), revision: ($rev|tonumber)}],
                                    customTagAudit: [{customTagGuid: $guid, textValue: $email}],
                                    comment: "",
                                    hasTagComment: false
                                }
                            }')

                        curl -s -X POST \
                            -H "Content-Type: application/json" \
                            -H "Authorization: FortifyToken $fortify_unified_login_token" \
                            -d "$payloadAuthor" \
                            "$fortify_ssc_api_url/projectVersions/$fortify_project_version_id/issues/action?silent=true"
                    done

                    echo "‚úÖ Processo conclu√≠do: todas as vulnerabilidades cr√≠ticas/altas foram marcadas com o Author."

                    
                    echo "‚öôÔ∏è  Iniciando processamento das regras de gate para o projeto."
                    
                    regras_json='[
                      {
                        "gate": "audited:false [fortify priority order]:critical [fortify priority order]:high",
                        "name": "default",
                        "bypass": "false",
                        "useIssuesDate": "false",
                        "issuesDate": ""
                      },
                      {
                        "gate": "audited:false [fortify priority order]:critical [fortify priority order]:high",
                        "name": "dvop-template-android-app-unico",
                        "bypass": "false",
                        "useIssuesDate": "true",
                        "issuesDate": "2025-10-01"
                      }
                    ]'
                    
                    # ‚ú® NOVO: Busca regra espec√≠fica do projeto ou usa default
                    project_name="$fortify_project_name"
                    regra_especifica=$(echo "$regras_json" | jq --compact-output --raw-output ".[] | select(.name==\"$project_name\")")
                    
                    if [ -z "$regra_especifica" ]; then
                        echo "‚öôÔ∏è  Usando regra 'default' para o projeto $project_name"
                        gate=$(echo "$regras_json" | jq --compact-output --raw-output '.[] | select(.name=="default") | .gate')
                        bypass=$(echo "$regras_json" | jq --compact-output --raw-output '.[] | select(.name=="default") | .bypass')
                        use_issues_date=$(echo "$regras_json" | jq --compact-output --raw-output '.[] | select(.name=="default") | .useIssuesDate')
                        issues_date=$(echo "$regras_json" | jq --compact-output --raw-output '.[] | select(.name=="default") | .issuesDate')
                    else
                        echo "‚öôÔ∏è  Usando regra espec√≠fica para o projeto $project_name"
                        gate=$(echo "$regra_especifica" | jq --compact-output --raw-output '.gate')
                        bypass=$(echo "$regra_especifica" | jq --compact-output --raw-output '.bypass')
                        use_issues_date=$(echo "$regra_especifica" | jq --compact-output --raw-output '.useIssuesDate')
                        issues_date=$(echo "$regra_especifica" | jq --compact-output --raw-output '.issuesDate')
                    fi
                    
                    echo "üìã Configura√ß√£o aplicada:"
                    echo "   - Gate: $gate"
                    echo "   - Bypass: $bypass"
                    echo "   - Filtro por data: $use_issues_date"
                    [ ! -z "$issues_date" ] && echo "   - Data de corte: $issues_date"
                    
                    # Verifica se a regra ser√° aplicada ou ignorada (bypass)
                    if [ "$bypass" == "true" ]; then
                        echo "‚ö†Ô∏è  Bypass ativado: a regra n√£o ser√° aplicada."
                        echo "‚úÖ Continua√ß√£o do pipeline permitida."
                    else
                        echo "üîí Bypass desativado: aplicando regra de gate."
                        
                        # Monta o filtro base
                        filtro_aplicado="$gate"
                        
                        # ‚ú® NOVO: Adiciona filtro de data se configurado
                        if [ "$use_issues_date" == "true" ] && [ ! -z "$issues_date" ]; then
                            echo "üìÖ Filtrando issues encontradas AP√ìS $issues_date"
                            filtro_aplicado="$filtro_aplicado foundDate:[$issues_date,*]"
                        fi
                        
                        echo "üîç Filtro completo aplicado: \`$filtro_aplicado\`"
                        filtro_url_encoded=$(echo "$filtro_aplicado" | jq -sRr '@uri')
                        echo "üì° Consultando vulnerabilidades no Fortify SSC..."
                    
                        response=$(curl -sS -k -X GET --header 'Content-Type: application/json' \
                            --header 'Accept: application/json' \
                            --header "Authorization: FortifyToken $fortify_unified_login_token" \
                            "$fortify_ssc_api_url/projectVersions/$fortify_project_version_id/issues?qm=issues&q=$filtro_url_encoded")
                        exit_code=$?
                    
                        fortify_verificar_resposta_api
                    
                        num_issues=$(echo "$response" | jq '.count')
                    
                        if [ "$num_issues" -gt 0 ]; then
                            if [ "$use_issues_date" == "true" ] && [ ! -z "$issues_date" ]; then
                                echo "‚ùå Gate falhou: **$num_issues** vulnerabilidades NOVAS encontradas (ap√≥s $issues_date)."
                            else
                                echo "‚ùå Gate falhou: **$num_issues** vulnerabilidades encontradas com base no filtro aplicado."
                            fi
                            echo "üìÑ Verifique o relat√≥rio detalhado no Fortify SSC."
                            echo '  _____       __         ____       _  __ '
                            echo ' / ___/___ _ / /_ ___   / __/___ _ (_)/ / '
                            echo '/ (_ // _ `// __// -_) / _/ / _ `// // /  '
                            echo '\___/ \_,_/ \__/ \__/ /_/   \_,_//_//_/   '
                            exit 1
                        else
                            if [ "$use_issues_date" == "true" ] && [ ! -z "$issues_date" ]; then
                                echo "‚úÖ Gate aprovado: Nenhuma vulnerabilidade nova cr√≠tica/alta encontrada (ap√≥s $issues_date)."
                            else
                                echo "‚úÖ Gate aprovado: Nenhuma vulnerabilidade cr√≠tica ou alta encontrada."
                            fi
                            echo "üöÄ Continua√ß√£o do build autorizada."
                            echo '  _____       __         ___                 '
                            echo ' / ___/___ _ / /_ ___   / _ \ ___ _ ___  ___ '
                            echo '/ (_ // _ `// __// -_) / ___// _ `/(_-< (_-< '
                            echo '\___/ \_,_/ \__/ \__/ /_/    \_,_//___//___/ '
                        fi
                    fi
