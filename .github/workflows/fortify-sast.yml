name: Fortify SAST

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      version:
        required: true
        type: string
      fortify_scancentral_tool:
        required: true
        type: string
      fortify_translate_name:
        required: true
        type: string
      fortify_translate_additional_flags:
        required: true
        type: string
    secrets:
      FORTIFY_SSC_API_URL:
        required: true
      FORTIFY_UNIFIED_LOGIN_TOKEN:
        required: true
      FORTIFY_CONTROLLER_URL:
        required: true
      FORTIFY_CONTROLLER_TOKEN:
        required: true

jobs:
  scan:
    name: Fortify SAST Scan
    runs-on: self-hosted

    steps:
      - name: ğŸ“Œ Run Scan
        env:
          fortify_project_name: ${{ inputs.name }}
          fortify_version_name: ${{ inputs.version }}
          fortify_translate_name: ${{ inputs.fortify_translate_name }}
          fortify_scancentral_tool: ${{ inputs.fortify_scancentral_tool }}
          fortify_translate_additional_flags: ${{ inputs.fortify_translate_additional_flags }}
          fortify_ssc_api_url: ${{ secrets.FORTIFY_SSC_API_URL }}
          fortify_unified_login_token: ${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}
          fortify_controller_url: ${{ secrets.FORTIFY_CONTROLLER_URL }}
          fortify_controller_token: ${{ secrets.FORTIFY_CONTROLLER_TOKEN }}
        run: |
          echo "ğŸš€ Executando Fortify SAST..."
          # Coloque aqui todo seu script existente para rodar o scan
          # Esse Ã© o seu bloco principal de criaÃ§Ã£o de projeto, versÃ£o, config, regras, gate etc.
          
          # Exemplo de placeholder:
          echo "âœ… Fortify Scan finalizado!"

          # Salva o ID da versÃ£o para usar nos passos seguintes:
          echo "FORTIFY_PROJECT_VERSION_ID=$fortify_project_version_id" >> $GITHUB_ENV

      - name: ğŸ“¥ Download FPR do SSC
        run: |
          echo "ğŸ”— Baixando FPR..."
          curl -sS -k -X GET \
            --header "Authorization: FortifyToken ${{ secrets.FORTIFY_UNIFIED_LOGIN_TOKEN }}" \
            "${{ secrets.FORTIFY_SSC_API_URL }}/projectVersions/${{ env.FORTIFY_PROJECT_VERSION_ID }}/resultDownload" \
            --output results.fpr

      - name: ğŸ”„ Converter FPR em SARIF
        run: |
          echo "ğŸ—ƒï¸  Convertendo FPR para SARIF..."
          docker run --rm -v "$PWD:/work" fortifydocker/fortify-ssc-parser-sarif \
            -i /work/results.fpr -o /work/results.sarif

      - name: ğŸ“¤ Upload SARIF como artefato
        uses: actions/upload-artifact@v4
        with:
          name: fortify-sast-sarif
          path: results.sarif

      - name: ğŸ“¡ Upload SARIF para Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
